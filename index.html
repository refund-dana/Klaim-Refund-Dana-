<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Keuangan & Stok Profesional</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --dark: #1e293b;
            --light: #f8fafc;
            --success: #16a34a;
            --danger: #dc2626;
            --border: #e2e8f0;
        }

        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { margin: 0; background: var(--light); display: flex; height: 100vh; overflow: hidden; }

        /* Sidebar */
        .sidebar {
            width: 250px; background: var(--dark); color: white; display: flex; flex-direction: column;
            padding: 1.5rem; flex-shrink: 0;
        }
        .logo { font-size: 1.2rem; font-weight: bold; margin-bottom: 2rem; border-bottom: 1px solid #334155; padding-bottom: 1rem; }
        .menu-item {
            padding: 10px; margin-bottom: 5px; cursor: pointer; border-radius: 6px; color: #cbd5e1;
        }
        .menu-item:hover, .menu-item.active { background: var(--primary); color: white; }
        .menu-item.danger { color: #fca5a5; margin-top: auto; }
        .menu-item.danger:hover { background: var(--danger); }

        /* Main Content */
        .main { flex: 1; padding: 2rem; overflow-y: auto; display: flex; flex-direction: column; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 8px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-pdf { background: var(--dark); color: white; }

        /* Report Container (Area to be printed) */
        #report-area { background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); min-height: 100%; }

        /* Cards */
        .stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 2rem; }
        .stat-card { border: 1px solid var(--border); padding: 1.5rem; border-radius: 8px; background: #fff; }
        .stat-label { font-size: 0.8rem; color: #64748b; text-transform: uppercase; }
        .stat-val { font-size: 1.5rem; font-weight: bold; margin-top: 5px; }
        .text-green { color: var(--success); }
        .text-red { color: var(--danger); }

        /* Input Form */
        .input-box { background: #eff6ff; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem; border: 1px solid #dbeafe; }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; align-items: end; }
        input, select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        label { font-size: 0.85rem; font-weight: 600; color: #475569; display: block; margin-bottom: 4px; }

        /* Tables */
        h3 { border-bottom: 2px solid var(--primary); padding-bottom: 5px; margin-top: 30px; color: var(--dark); }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border); }
        th { background: #f1f5f9; }
        .badge { padding: 4px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: bold; }
        .bg-in { background: #dcfce7; color: #166534; }
        .bg-out { background: #fee2e2; color: #991b1b; }

        /* PDF Styles */
        .pdf-header { display: none; text-align: center; margin-bottom: 20px; }
        .pdf-header h1 { margin: 0; font-size: 1.5rem; }
        .pdf-header p { margin: 5px 0; color: #666; }

        @media print {
            .no-print { display: none !important; }
            .sidebar { display: none; }
            .main { padding: 0; }
            #report-area { box-shadow: none; padding: 0; }
        }
    </style>
</head>
<body>

    <div class="sidebar no-print">
        <div class="logo">FINANCE & STOCK</div>
        <div class="menu-item active">üìä Dashboard Utama</div>
        <div class="menu-item danger" onclick="resetData()">üóëÔ∏è Reset Data (Mulai Baru)</div>
    </div>

    <div class="main">
        <div class="header no-print">
            <h2>Dashboard Harian</h2>
            <button class="btn btn-pdf" onclick="generatePDF()">
                üñ®Ô∏è Download Laporan PDF
            </button>
        </div>

        <div id="report-area">
            
            <div class="pdf-header" id="pdf-header-show">
                <h1>LAPORAN KEUANGAN & STOK</h1>
                <p>Periode Update: <span id="print-date"></span></p>
                <hr style="border: 1px solid #000; margin-top: 10px;">
            </div>

            <div class="stats-row">
                <div class="stat-card">
                    <div class="stat-label">Saldo Kas Akhir</div>
                    <div class="stat-val" style="color: var(--primary);" id="disp-saldo">Rp 0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Masuk</div>
                    <div class="stat-val text-green" id="disp-in">Rp 0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Keluar</div>
                    <div class="stat-val text-red" id="disp-out">Rp 0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Stok Bergerak (Pcs)</div>
                    <div class="stat-val" id="disp-qty">0</div>
                </div>
            </div>

            <div class="input-box no-print">
                <h4 style="margin-top:0; margin-bottom: 10px;">Input Transaksi Harian</h4>
                <form id="trxForm">
                    <div class="form-row">
                        <div>
                            <label>Tanggal</label>
                            <input type="date" id="i-date" required>
                        </div>
                        <div>
                            <label>Jenis Transaksi</label>
                            <select id="i-type" onchange="toggleQty()" required>
                                <option value="expense">üí∏ Biaya (Uang Keluar)</option>
                                <option value="income">üí∞ Pendapatan (Uang Masuk)</option>
                                <option value="buy">üì¶ Beli Stok (Uang - / Stok +)</option>
                                <option value="sell">üõí Jual Barang (Uang + / Stok -)</option>
                            </select>
                        </div>
                        <div>
                            <label>Keterangan</label>
                            <input type="text" id="i-desc" placeholder="Contoh: Listrik / Sepatu" required>
                        </div>
                        <div id="qty-box" style="display:none;">
                            <label>Qty Barang</label>
                            <input type="number" id="i-qty" placeholder="0">
                        </div>
                        <div>
                            <label>Nominal (Rp)</label>
                            <input type="number" id="i-amount" placeholder="0" required>
                        </div>
                        <button type="submit" class="btn btn-primary" style="height: 38px; margin-top: auto;">+ Simpan</button>
                    </div>
                </form>
            </div>

            <h3>Laporan Arus Kas</h3>
            <table id="table-money">
                <thead>
                    <tr>
                        <th>Tanggal</th>
                        <th>Keterangan</th>
                        <th>Kategori</th>
                        <th style="text-align:right;">Nominal</th>
                    </tr>
                </thead>
                <tbody id="body-money"></tbody>
            </table>

            <h3>Laporan Mutasi Stok</h3>
            <table id="table-stock">
                <thead>
                    <tr>
                        <th>Tanggal</th>
                        <th>Barang</th>
                        <th>Aktivitas</th>
                        <th style="text-align:center;">Jumlah</th>
                    </tr>
                </thead>
                <tbody id="body-stock"></tbody>
            </table>

            <div style="margin-top: 50px; display: none;" id="sign-area">
                <div style="float: right; text-align: center; width: 200px;">
                    <p>Dibuat Oleh,</p>
                    <br><br><br>
                    <p>(Admin Keuangan)</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. INISIALISASI & LOAD DATA ---
        let moneyData = JSON.parse(localStorage.getItem('moneyData')) || [];
        let stockData = JSON.parse(localStorage.getItem('stockData')) || [];

        // Set Default Date hari ini
        document.getElementById('i-date').valueAsDate = new Date();

        // Format Rupiah
        const fmtRp = (n) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(n);
        const fmtDate = (d) => new Date(d).toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' });

        // --- 2. FUNGSI LOGIKA UTAMA ---
        function render() {
            const bMoney = document.getElementById('body-money');
            const bStock = document.getElementById('body-stock');
            bMoney.innerHTML = '';
            bStock.innerHTML = '';

            let totalIn = 0, totalOut = 0, stockMove = 0;

            // Sort data berdasarkan tanggal terbaru
            moneyData.sort((a,b) => new Date(b.date) - new Date(a.date));
            stockData.sort((a,b) => new Date(b.date) - new Date(a.date));

            // Render Uang
            moneyData.forEach(m => {
                if(m.flow === 'in') totalIn += m.amount;
                else totalOut += m.amount;

                let color = m.flow === 'in' ? 'text-green' : 'text-red';
                let sign = m.flow === 'in' ? '+' : '-';
                let badge = m.flow === 'in' ? '<span class="badge bg-in">Masuk</span>' : '<span class="badge bg-out">Keluar</span>';

                bMoney.innerHTML += `
                    <tr>
                        <td>${fmtDate(m.date)}</td>
                        <td>${m.desc}</td>
                        <td>${badge}</td>
                        <td style="text-align:right;" class="${color}"><b>${sign} ${fmtRp(m.amount)}</b></td>
                    </tr>
                `;
            });

            // Render Stok
            stockData.forEach(s => {
                stockMove += s.qty;
                let badge = s.flow === 'in' ? '<span class="badge bg-in">Masuk</span>' : '<span class="badge bg-out">Keluar</span>';
                
                bStock.innerHTML += `
                    <tr>
                        <td>${fmtDate(s.date)}</td>
                        <td>${s.item}</td>
                        <td>${badge}</td>
                        <td style="text-align:center;"><b>${s.qty}</b></td>
                    </tr>
                `;
            });

            // Update Kartu Atas
            document.getElementById('disp-in').innerText = fmtRp(totalIn);
            document.getElementById('disp-out').innerText = fmtRp(totalOut);
            document.getElementById('disp-saldo').innerText = fmtRp(totalIn - totalOut);
            document.getElementById('disp-qty').innerText = stockData.length + " Transaksi";

            // Simpan ke LocalStorage
            localStorage.setItem('moneyData', JSON.stringify(moneyData));
            localStorage.setItem('stockData', JSON.stringify(stockData));
        }

        // --- 3. HANDLE INPUT ---
        function toggleQty() {
            const type = document.getElementById('i-type').value;
            const qtyBox = document.getElementById('qty-box');
            if(type === 'buy' || type === 'sell') {
                qtyBox.style.display = 'block';
                document.getElementById('i-qty').setAttribute('required', 'true');
            } else {
                qtyBox.style.display = 'none';
                document.getElementById('i-qty').removeAttribute('required');
            }
        }

        document.getElementById('trxForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const date = document.getElementById('i-date').value;
            const type = document.getElementById('i-type').value;
            const desc = document.getElementById('i-desc').value;
            const amount = parseFloat(document.getElementById('i-amount').value);
            const qty = parseFloat(document.getElementById('i-qty').value) || 0;

            // LOGIKA PINTAR
            if(type === 'expense') {
                moneyData.push({ date, desc, flow: 'out', amount });
            } else if (type === 'income') {
                moneyData.push({ date, desc, flow: 'in', amount });
            } else if (type === 'buy') {
                moneyData.push({ date, desc: `Beli Stok: ${desc}`, flow: 'out', amount });
                stockData.push({ date, item: desc, flow: 'in', qty });
            } else if (type === 'sell') {
                moneyData.push({ date, desc: `Penjualan: ${desc}`, flow: 'in', amount });
                stockData.push({ date, item: desc, flow: 'out', qty });
            }

            e.target.reset();
            document.getElementById('i-date').valueAsDate = new Date();
            toggleQty();
            render();
            alert("Data tersimpan!");
        });

        // --- 4. RESET DATA ---
        function resetData() {
            if(confirm("Yakin ingin menghapus SEMUA data? Ini tidak bisa dibatalkan.")) {
                localStorage.clear();
                moneyData = [];
                stockData = [];
                render();
            }
        }

        // --- 5. GENERATE PDF ---
        function generatePDF() {
            const element = document.getElementById('report-area');
            const pdfHeader = document.getElementById('pdf-header-show');
            const signArea = document.getElementById('sign-area');
            const dateSpan = document.getElementById('print-date');

            // Persiapan Tampilan PDF
            dateSpan.innerText = new Date().toLocaleDateString('id-ID', {weekday: 'long', day:'numeric', month:'long', year:'numeric'});
            pdfHeader.style.display = 'block';
            signArea.style.display = 'block';

            // Opsi PDF
            const opt = {
                margin:       0.5,
                filename:     `Laporan_Keuangan_${new Date().toISOString().slice(0,10)}.pdf`,
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { scale: 2 },
                jsPDF:        { unit: 'in', format: 'a4', orientation: 'portrait' }
            };

            // Proses Generate
            html2pdf().set(opt).from(element).save().then(() => {
                // Kembalikan Tampilan Normal setelah download
                pdfHeader.style.display = 'none';
                signArea.style.display = 'none';
            });
        }

        // Render awal saat halaman dibuka
        render();

    </script>
</body>
</html>
