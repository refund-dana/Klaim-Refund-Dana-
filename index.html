<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Keuangan, Stok & Piutang</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root {
            --primary: #2563eb; --dark: #0f172a; --light: #f8fafc;
            --success: #10b981; --danger: #ef4444; --warning: #f59e0b;
            --border: #e2e8f0;
        }
        * { box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { margin: 0; background: var(--light); display: flex; height: 100vh; }

        /* Sidebar */
        .sidebar { width: 260px; background: var(--dark); color: white; padding: 1.5rem; flex-shrink: 0; display: flex; flex-direction: column; }
        .logo { font-size: 1.2rem; font-weight: 800; margin-bottom: 2rem; color: #38bdf8; border-bottom: 1px solid #1e293b; padding-bottom: 1rem; }
        .menu-item { padding: 12px; margin-bottom: 5px; cursor: pointer; border-radius: 8px; color: #94a3b8; transition: 0.3s; }
        .menu-item:hover, .menu-item.active { background: #1e293b; color: white; }
        .menu-item.active { border-left: 4px solid var(--primary); }

        /* Content Area */
        .main { flex: 1; padding: 2rem; overflow-y: auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        
        /* Stats Cards */
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 2rem; }
        .card { background: white; padding: 1.2rem; border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .card-label { font-size: 0.75rem; color: #64748b; font-weight: 700; text-transform: uppercase; }
        .card-val { font-size: 1.4rem; font-weight: 800; margin-top: 5px; }

        /* Form Input */
        .input-box { background: white; padding: 1.5rem; border-radius: 12px; border: 1px solid var(--primary); margin-bottom: 2rem; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; align-items: end; }
        input, select { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 0.9rem; }
        label { font-size: 0.8rem; font-weight: 600; margin-bottom: 5px; display: block; }
        .btn { padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: 700; transition: 0.2s; }
        .btn-add { background: var(--primary); color: white; width: 100%; }
        .btn-pdf { background: #475569; color: white; }
        .btn-pay { background: var(--success); color: white; font-size: 0.7rem; padding: 4px 8px; }

        /* Tables */
        .section-title { margin: 2rem 0 1rem; padding-left: 10px; border-left: 4px solid var(--primary); font-size: 1.1rem; }
        .table-res { background: white; border-radius: 12px; border: 1px solid var(--border); overflow: hidden; margin-bottom: 1rem; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--border); }
        th { background: #f8fafc; color: #64748b; font-weight: 600; }
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.7rem; font-weight: bold; }
        .bg-lunas { background: #dcfce7; color: #15803d; }
        .bg-hutang { background: #fef3c7; color: #92400e; }
        
        #pdf-header { display: none; text-align: center; margin-bottom: 20px; border-bottom: 2px solid #000; padding-bottom: 10px; }

        @media print { .no-print { display: none; } }
    </style>
</head>
<body>

    <div class="sidebar no-print">
        <div class="logo">POS SYSTEM PRO</div>
        <div class="menu-item active">üìä Dashboard</div>
        <div class="menu-item" onclick="generatePDF()">üì• Cetak Laporan</div>
        <div class="menu-item" style="color:var(--danger); margin-top: auto;" onclick="resetAll()">‚ö†Ô∏è Reset Data</div>
    </div>

    <div class="main">
        <div class="header no-print">
            <h2>Ringkasan Keuangan & Sangkutan</h2>
            <div id="clock" style="font-weight: bold; color: var(--primary);"></div>
        </div>

        <div id="print-area">
            <div id="pdf-header">
                <h2>LAPORAN HARIAN TERINTEGRASI</h2>
                <p id="pdf-date"></p>
            </div>

            <div class="stats-grid">
                <div class="card">
                    <div class="card-label">Saldo Kas Riil</div>
                    <div class="card-val" id="stat-cash" style="color:var(--primary)">Rp 0</div>
                </div>
                <div class="card">
                    <div class="card-label">Total Sangkutan (Piutang)</div>
                    <div class="card-val" id="stat-debt" style="color:var(--warning)">Rp 0</div>
                </div>
                <div class="card">
                    <div class="card-label">Total Pemasukan</div>
                    <div class="card-val text-green" id="stat-in">Rp 0</div>
                </div>
                <div class="card">
                    <div class="card-label">Total Pengeluaran</div>
                    <div class="card-val text-red" id="stat-out">Rp 0</div>
                </div>
            </div>

            <div class="input-box no-print">
                <form id="mainForm">
                    <div class="form-grid">
                        <div>
                            <label>Tanggal</label>
                            <input type="date" id="f-date" required>
                        </div>
                        <div>
                            <label>Jenis</label>
                            <select id="f-type" onchange="checkType()">
                                <option value="income">üíµ Pendapatan (Kas)</option>
                                <option value="expense">üí∏ Pengeluaran (Kas)</option>
                                <option value="sell_debt">üõí Jual Barang (Sangkutan/Hutang)</option>
                            </select>
                        </div>
                        <div>
                            <label>Nama/Keterangan</label>
                            <input type="text" id="f-desc" placeholder="Contoh: Bpk. Budi / Listrik" required>
                        </div>
                        <div>
                            <label>Nominal (Rp)</label>
                            <input type="number" id="f-amount" required>
                        </div>
                        <button type="submit" class="btn btn-add">Simpan Data</button>
                    </div>
                </form>
            </div>

            <div class="section-title">üì¶ Daftar Sangkutan / Belum Lunas</div>
            <div class="table-res">
                <table>
                    <thead>
                        <tr>
                            <th>Tanggal</th>
                            <th>Nama Penanggung</th>
                            <th>Status</th>
                            <th>Sisa Tagihan</th>
                            <th class="no-print">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="body-debt"></tbody>
                </table>
            </div>

            <div class="section-title">üìë Riwayat Arus Kas (Uang Masuk/Keluar)</div>
            <div class="table-res">
                <table>
                    <thead>
                        <tr>
                            <th>Tanggal</th>
                            <th>Keterangan</th>
                            <th>Status</th>
                            <th style="text-align:right">Nominal</th>
                        </tr>
                    </thead>
                    <tbody id="body-cash"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let db = JSON.parse(localStorage.getItem('pos_db')) || { cash: [], debt: [] };
        const fmt = (n) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(n);

        document.getElementById('f-date').valueAsDate = new Date();

        function checkType() {
            // Optional: Logic untuk merubah label jika diperlukan
        }

        document.getElementById('mainForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const date = document.getElementById('f-date').value;
            const type = document.getElementById('f-type').value;
            const desc = document.getElementById('f-desc').value;
            const amount = parseFloat(document.getElementById('f-amount').value);

            if(type === 'income') {
                db.cash.push({ date, desc, type: 'in', amount });
            } else if(type === 'expense') {
                db.cash.push({ date, desc, type: 'out', amount });
            } else if(type === 'sell_debt') {
                db.debt.push({ id: Date.now(), date, desc, amount, status: 'Nyangkut' });
            }

            saveAndRender();
            e.target.reset();
            document.getElementById('f-date').valueAsDate = new Date();
        });

        function markAsPaid(id) {
            const index = db.debt.findIndex(d => d.id === id);
            if(index !== -1) {
                const item = db.debt[index];
                // Masukkan ke kas
                db.cash.push({ 
                    date: new Date().toISOString().split('T')[0], 
                    desc: `Pelunasan: ${item.desc}`, 
                    type: 'in', 
                    amount: item.amount 
                });
                // Hapus dari sangkutan
                db.debt.splice(index, 1);
                saveAndRender();
                alert("Berhasil Dilunasi! Uang otomatis masuk ke kas riil.");
            }
        }

        function saveAndRender() {
            localStorage.setItem('pos_db', JSON.stringify(db));
            
            const bCash = document.getElementById('body-cash');
            const bDebt = document.getElementById('body-debt');
            bCash.innerHTML = ''; bDebt.innerHTML = '';

            let sIn = 0, sOut = 0, sDebt = 0;

            // Render Kas
            db.cash.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(c => {
                if(c.type === 'in') sIn += c.amount; else sOut += c.amount;
                bCash.innerHTML += `<tr>
                    <td>${c.date}</td>
                    <td>${c.desc}</td>
                    <td><span class="badge ${c.type==='in'?'bg-lunas':'bg-out'}">${c.type==='in'?'Masuk':'Keluar'}</span></td>
                    <td style="text-align:right; font-weight:bold" class="${c.type==='in'?'text-green':'text-red'}">
                        ${c.type==='in'?'+':'-'} ${fmt(c.amount)}
                    </td>
                </tr>`;
            });

            // Render Debt
            db.debt.forEach(d => {
                sDebt += d.amount;
                bDebt.innerHTML += `<tr>
                    <td>${d.date}</td>
                    <td>${d.desc}</td>
                    <td><span class="badge bg-hutang">Sangkutan</span></td>
                    <td style="font-weight:bold; color:var(--warning)">${fmt(d.amount)}</td>
                    <td class="no-print"><button class="btn btn-pay" onclick="markAsPaid(${d.id})">Lunasi ‚úÖ</button></td>
                </tr>`;
            });

            document.getElementById('stat-cash').innerText = fmt(sIn - sOut);
            document.getElementById('stat-in').innerText = fmt(sIn);
            document.getElementById('stat-out').innerText = fmt(sOut);
            document.getElementById('stat-debt').innerText = fmt(sDebt);
        }

        function generatePDF() {
            const element = document.getElementById('print-area');
            document.getElementById('pdf-header').style.display = 'block';
            document.getElementById('pdf-date').innerText = "Dicetak pada: " + new Date().toLocaleString();
            
            html2pdf().from(element).set({
                margin: 0.5,
                filename: 'Laporan_Keuangan_Sangkutan.pdf',
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
            }).save().then(() => {
                document.getElementById('pdf-header').style.display = 'none';
            });
        }

        function resetAll() {
            if(confirm("Hapus semua data?")) {
                db = { cash: [], debt: [] };
                saveAndRender();
            }
        }

        setInterval(() => {
            document.getElementById('clock').innerText = new Date().toLocaleTimeString();
        }, 1000);

        saveAndRender();
    </script>
</body>
</html>
